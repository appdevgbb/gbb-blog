"use strict";(globalThis.webpackChunkdocusaurus=globalThis.webpackChunkdocusaurus||[]).push([[287],{2418:e=>{e.exports=JSON.parse('{"permalink":"/2023/10/12/aks-user-min-roles","editUrl":"https://github.com/appdevgbb/gbb-blog/tree/main/docusaurus/blog/2023-10-12/aks-user-min-roles/index.md","source":"@site/blog/2023-10-12/aks-user-min-roles/index.md","title":"AKS User Minimum Roles","description":"How to use Azure AD RBAC in Azure Kubernetes Service","date":"2023-10-12T00:00:00.000Z","tags":[],"readingTime":6.82,"hasTruncateMarker":true,"authors":[{"name":"Steve Griffith","title":"Principal Cloud Architect, Azure Global Black Belt","url":"https://github.com/swgriffith","socials":{"x":"https://x.com/SteveGriffith","github":"https://github.com/swgriffith"},"imageURL":"https://github.com/swgriffith.png","key":"steve_griffith","page":null}],"frontMatter":{"authors":["steve_griffith"],"date":"2023-10-12","description":"How to use Azure AD RBAC in Azure Kubernetes Service","tags":[],"title":"AKS User Minimum Roles"},"unlisted":false,"prevItem":{"title":"AKS Custom Policy","permalink":"/2023/10/26/aks-custom-policy"},"nextItem":{"title":"Using App Gateway for Containers with Egress Lockdown","permalink":"/2023/09/21/agc-egress-lockdown"}}')},5047:(e,n,s)=>{s.d(n,{A:()=>a});const a=s.p+"assets/images/oob-roles-95f2bb6ba7c40a0bb939397e236ae0be.jpg"},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>o});var a=s(6540);const t={},r=a.createContext(t);function l(e){const n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),a.createElement(r.Provider,{value:n},e.children)}},9781:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>a,toc:()=>c});var a=s(2418),t=s(4848),r=s(8453);const l={authors:["steve_griffith"],date:"2023-10-12",description:"How to use Azure AD RBAC in Azure Kubernetes Service",tags:[],title:"AKS User Minimum Roles"},o=void 0,i={authorsImageUrls:[void 0]},c=[{value:"Setup",id:"setup",level:2},{value:"Cluster Creation",id:"cluster-creation",level:3},{value:"Create the test service principal",id:"create-the-test-service-principal",level:3},{value:"Allow user to call &#39;az aks get-credentials&#39;",id:"allow-user-to-call-az-aks-get-credentials",level:3},{value:"Try to access kubernetes objects",id:"try-to-access-kubernetes-objects",level:3},{value:"Enable sample-app namespace access with Azure AD RBAC",id:"enable-sample-app-namespace-access-with-azure-ad-rbac",level:3},{value:"Explore the Out of the Box Roles",id:"explore-the-out-of-the-box-roles",level:3},{value:"Create a custom role definition",id:"create-a-custom-role-definition",level:2},{value:"Conclusion",id:"conclusion",level:2}];function u(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"The following provides guidance on the minimum roles needed by an AKS user to get their credentials and interact with a namespace we'll create called 'sample-app'."}),"\n",(0,t.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,t.jsx)(n.p,{children:"First we'll create an AKS cluster with Azure AD integrated authentication and Azure AD RBAC enabled. We will leave 'local accounts' enabled for simplicity, but that option would typically be disabled and you would provide AKS an admin user Group ID for cluster admin access."}),"\n",(0,t.jsx)(n.h3,{id:"cluster-creation",children:"Cluster Creation"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"SUBSCRIPTION_ID=''\nRG=EphAADDemo\nLOC=eastus\nCLUSTER_NAME=aad-demo\n\n# Create the resource group\naz group create -n $RG -l $LOC\n\n# Create the cluster\naz aks create \\\n-g $RG \\\n-n $CLUSTER_NAME \\\n--enable-aad \\\n--enable-azure-rbac\n\n# Get the admin credential so we can create the namespace\naz aks get-credentials -g $RG -n $CLUSTER_NAME --admin\n\n# Create the namespace\nkubectl create ns sample-app\n\n# Deploy an app\nkubectl create deployment nginx --image=nginx --namespace sample-app\n\n# Expose the deployment as a Kubernetes service\nkubectl expose deployment nginx --port 8080 --target-port 80 --namespace sample-app\n\n# Create a secret\nkubectl create secret generic sample-secret --from-literal=message=Hello -n sample-app\n\n# Check out the created resources\nkubectl get all -n sample-app\n"})}),"\n",(0,t.jsx)(n.h3,{id:"create-the-test-service-principal",children:"Create the test service principal"}),"\n",(0,t.jsx)(n.p,{children:"We'll create a service principal with no rights to use as our user account."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Create the sample app user\naz ad sp create-for-rbac --skip-assignment -o json > sample-app-team-user.json\n\n# Get the App ID and Password into some variables we can use\nAPP_ID=$(cat sample-app-team-user.json|jq -r .appId)\nAPP_SECRET=$(cat sample-app-team-user.json|jq -r .password)\nTENANT=$(cat sample-app-team-user.json|jq -r .tenant)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"allow-user-to-call-az-aks-get-credentials",children:"Allow user to call 'az aks get-credentials'"}),"\n",(0,t.jsx)(n.p,{children:"We need to be able to get the cluster access details, which will live in the 'kubeconfig' file and include the cluster FQDN and API access certificates. We got the admin credentials above, but we dont want to use those. We'll use the admin credential again later, so dont delete it just yet."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# First we need the resource ID for the cluster\nCLUSTER_RESOURCE_ID=$(az aks show -g $RG -n $CLUSTER_NAME -o tsv --query id)\n\n# Take a look at the role definition we\'ll apply\n# In particular, look at the enabled actions\naz role definition list --name "Azure Kubernetes Service Cluster User Role" -o yaml\n\n# Give our user the role\naz role assignment create \\\n--assignee $APP_ID \\\n--scope $CLUSTER_RESOURCE_ID \\\n--role "Azure Kubernetes Service Cluster User Role"\n\n# Login as the assigned user\naz login --service-principal -u $APP_ID -p $APP_SECRET --tenant $TENANT\n\n# Check your basic access\n# You should be able to list AKS clusters only\naz aks list\n\n# You should not be able to see any resource groups, vms, etc\naz group list\naz vm list\n\n# Now try to get AKS cluster credentials\naz aks get-credentials -g $RG -n $CLUSTER_NAME\n'})}),"\n",(0,t.jsxs)(n.p,{children:["This is where things get a little weird in our scenario. We're signing in as a service account. In the next step we'll try to use the kubernetes cli (kubectl), and for normal human users you would get a device login prompt, which will take you to your normal Azure AD multi-factor auth flow. However, we're using a service principal so we need to take a few extra steps and use the ",(0,t.jsx)(n.a,{href:"https://azure.github.io/kubelogin/quick-start.html",children:"kubelogin"})," project to sign in."]}),"\n",(0,t.jsxs)(n.p,{children:["You'll likely need to install kubelogin. You can find the installation steps here: ",(0,t.jsx)(n.a,{href:"https://azure.github.io/kubelogin/install.html",children:"Installation"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Convert the kube config file with kubelogin\nkubelogin convert-kubeconfig -l azurecli\n"})}),"\n",(0,t.jsx)(n.h3,{id:"try-to-access-kubernetes-objects",children:"Try to access kubernetes objects"}),"\n",(0,t.jsx)(n.p,{children:"When you try to access any kubernetes resources you'll find your service account has no access. We'll just check for namespace list access, but you'll see the same across any resource as we have not done anything yet with Kubernetes level RBAC."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'kubectl get ns\n\n# Sample Error Message\nError from server (Forbidden): namespaces is forbidden: User "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxx" cannot list resource "namespaces" in API group "" at the cluster scope: User does not have access to the resource in Azure. Update role assignment to allow access.\n'})}),"\n",(0,t.jsx)(n.h3,{id:"enable-sample-app-namespace-access-with-azure-ad-rbac",children:"Enable sample-app namespace access with Azure AD RBAC"}),"\n",(0,t.jsx)(n.p,{children:"We'll need to jump out of our service principal login back to our normal user account, so we can create some new role assignments."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Login to Azure\naz login\n\n# If needed, set your subscription\naz account set -s <SUBSCRIPTION ID>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Lets assign read-only access to the 'sample-app' namespace alone for our service principal."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'az role assignment create --role "Azure Kubernetes Service RBAC Reader" --assignee $APP_ID --scope $CLUSTER_RESOURCE_ID/namespaces/sample-app\n\n# Log back in as the service principal\naz login --service-principal -u $APP_ID -p $APP_SECRET --tenant $TENANT\n\n# Try to access resources in the cluster\n# This command will be forbidden\nkubectl get ns\n\n# Try a few other commands, and you\'ll see them fail.\n\n# Now try to read resources from the permitted namespace\n# This command will succeed\nkubectl get all -n sample-app\n\n# We can also view the pod logs\nkubectl logs -l app=nginx -n sample-app\n\n# Secrets and roles have special treatment, so they are not visible. Try to look at secrets and roles\n# These will fail\nkubectl get secrets -n sample-app\nkubectl get roles\n\n# We only granted read-only, so lets try to create something\n# This will fail\nkubectl run nginx-fail --image=nginx -n sample-app\n\n'})}),"\n",(0,t.jsx)(n.p,{children:"Now lets increase the scope beyond our namespace and give the service principal read access across the whole cluster. You'll have to log back in with your normal user account to grant the role."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Again, log back into your other account\naz login\n\n# Delete the previous role assignment\naz role assignment delete --role "Azure Kubernetes Service RBAC Reader" --assignee $APP_ID --scope $CLUSTER_RESOURCE_ID/namespaces/sample-app\n\n# Create the new role assignment\naz role assignment create --role "Azure Kubernetes Service RBAC Reader" --assignee $APP_ID --scope $CLUSTER_RESOURCE_ID\n\n# Log back in as your service principal account\naz login --service-principal -u $APP_ID -p $APP_SECRET --tenant $TENANT\n\n# Now run some commands to see if you can read the whole cluster\nkubectl get all -A\nkubectl get pods -A\n\n# Now try to delete something, like our sample-app namespace\n# This command will be forbidden\nkubectl delete ns sample-app\n\n# Again, as mentioned with the namespace scope, secrets and roles are special. Try to view secrets and roles\n# These will fail\nkubectl get secrets -A\nkubectl get roles\n'})}),"\n",(0,t.jsx)(n.h3,{id:"explore-the-out-of-the-box-roles",children:"Explore the Out of the Box Roles"}),"\n",(0,t.jsxs)(n.p,{children:["AKS provides 4 out of the box roles for Azure RBAC in Kubernetes. You can read more ",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/aks/manage-azure-rbac#create-role-assignments-for-users-to-access-the-cluster",children:"here"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"OOB Roles",src:s(5047).A+"",width:"866",height:"392"})}),"\n",(0,t.jsx)(n.h2,{id:"create-a-custom-role-definition",children:"Create a custom role definition"}),"\n",(0,t.jsx)(n.p,{children:"If we want to expand the role to include secrets reader access then we'll need a custom role."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Make sure you\'re logged in as your normal user account\n\n# Create the role definition file\ncat << EOF > secrets-aad-role.json\n{\n    "Name": "AKS Sample App Secrets Reader",\n    "Description": "Lets you view all Secrets in the sample-app namespace.",\n    "Actions": [],\n    "NotActions": [],\n    "DataActions": [\n        "Microsoft.ContainerService/managedClusters/secrets/read"\n    ],\n    "NotDataActions": [],\n    "assignableScopes": [\n        "subscriptions/$SUBSCRIPTION_ID"\n    ]\n}\nEOF\n\n# Create the role definition in Azure\naz role definition create --role-definition @secrets-aad-role.json\n\n#####################################################################\n#\n# NOTE!!! Role propegation may take a couple minutes, so if this fails\n# wait a minute and try again.\n#\n#####################################################################\n\n# Assign the role\naz role assignment create --role "AKS Sample App Secrets Reader" --assignee $APP_ID --scope $CLUSTER_RESOURCE_ID/namespaces/sample-app\n'})}),"\n",(0,t.jsx)(n.p,{children:"Now that the custom role has been created and applied, we can log back in as our service principal and test it's ability to view secrets."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Log in as the service principal\naz login --service-principal -u $APP_ID -p $APP_SECRET --tenant $TENANT\n\n# Look at the secret created previously\nkubectl get secrets -n sample-app\n\n# Get the value out of the secret...keeping mind that secrets are base64 encoded\nkubectl get secret sample-secret -n sample-app -o jsonpath='{.data.message}'|base64 --decode\n"})}),"\n",(0,t.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,t.jsx)(n.p,{children:"This walk-through demonstrated setting up an AKS cluster with Azure AD authenitication and Azure AD RBAC enabled, and then how to use Azure built in roles, as well as custom roles, to interact with your cluster."})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}}}]);