<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Securing your AKS cluster with a Linux Firewall VM | Azure Global Blackbelt</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://azureglobalblackbelts.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://azureglobalblackbelts.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://azureglobalblackbelts.com/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Securing your AKS cluster with a Linux Firewall VM | Azure Global Blackbelt"><meta data-rh="true" name="description" content="How to configure the firewall VM, the virtual network, and the network security group to route traffic to your AKS endpoints."><meta data-rh="true" property="og:description" content="How to configure the firewall VM, the virtual network, and the network security group to route traffic to your AKS endpoints."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-02-02T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/dcasati"><link data-rh="true" rel="icon" href="/img/gbb.png"><link data-rh="true" rel="canonical" href="https://azureglobalblackbelts.com/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm"><link data-rh="true" rel="alternate" href="https://azureglobalblackbelts.com/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm" hreflang="en"><link data-rh="true" rel="alternate" href="https://azureglobalblackbelts.com/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://azureglobalblackbelts.com/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm","mainEntityOfPage":"https://azureglobalblackbelts.com/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm","url":"https://azureglobalblackbelts.com/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm","headline":"Securing your AKS cluster with a Linux Firewall VM","name":"Securing your AKS cluster with a Linux Firewall VM","description":"How to configure the firewall VM, the virtual network, and the network security group to route traffic to your AKS endpoints.","datePublished":"2024-02-02T00:00:00.000Z","author":{"@type":"Person","name":"Diego Casati","description":"Principal Cloud Architect, Azure Global Black Belt","url":"https://github.com/dcasati","image":"https://github.com/dcasati.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://azureglobalblackbelts.com/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Azure Global Blackbelt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Azure Global Blackbelt Atom Feed"><link rel="stylesheet" href="/assets/css/styles.5718cfe7.css">
<script src="/assets/js/runtime~main.b4103c26.js" defer="defer"></script>
<script src="/assets/js/main.67e1397c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/gbb.png"><link rel="preload" as="image" href="https://github.com/dcasati.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/gbb.png" alt="Azure Global Blackbelt Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/gbb.png" alt="Azure Global Blackbelt Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Azure Global Blackbelt</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/appdevgbb" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/07/02/when-infrastructure-scales-but-understanding-doesnt">When Infrastructure Scales But Understanding Doesn&#x27;t</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/06/24/human-scale-problem-in-platform-engineering">The Human Scale Problem in Platform Engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/01/31/updating-aks-network-plugin-from-kubenet-to-azure-cni">Updating AKS Network Plugin from Kubenet to Azure CNI</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/11/05/afd-aks-ingress-tls">End to End TLS Encryption with AKS and AFD</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/09/06/multi-cluster-layer-4-load-balancing-with-fleet-manager">Multi-Cluster Layer 4 Load Balancing with Fleet Manager</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/08/15/aks-control-plane-log-filtering">Using Stream Analytics to Filter AKS Control Plane Logs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/04/16/aks-kaito">Using Project KAITO in AKS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/03/05/workload-identity-kv-csi">Using the Azure Key Vault CSI Driver with Workload Identity</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm">Securing your AKS cluster with a Linux Firewall VM</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/12/19/workload-identity-blob-example">Using Workload Idenity to Access Azure Blob Storage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/12/18/external-dns-workload-identity">Using External DNS in AKS with Azure Workload Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/27/capabilities-in-aks">Using Linux Capabilities in AKS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/09/part1-notation-usage">Image Verification Part 1 - Notation CLI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/09/part2-aks-image-verification">Image Verification Part 2 - Image Verification with Gatekeeper and Ratify</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/10/26/aks-custom-policy">AKS Custom Policy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/10/12/aks-user-min-roles">AKS User Minimum Roles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/agc-egress-lockdown">Using App Gateway for Containers with Egress Lockdown</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/kubelogin-terraform">Using Kubelogin with AKS via Terraform</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/workload-identity-example">Workload Identity</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-azuresql-example">Accessing Azure SQL DB via Workload Identity and Managed Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-self-managed-setup">Using Workload Identity with Self Managed Clusters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-windows-example">Workload Identity - Windows Nodepool Walkthrough</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Securing your AKS cluster with a Linux Firewall VM</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-02-02T00:00:00.000Z">February 2, 2024</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dcasati" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/dcasati.png" alt="Diego Casati"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/dcasati" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp" translate="no">Diego Casati</span></a></div><small class="authorTitle_nd0D" title="Principal Cloud Architect, Azure Global Black Belt">Principal Cloud Architect, Azure Global Black Belt</small><div class="authorSocials_rSDt"><a href="https://x.com/ve6dpc" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="X"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 1200 1227" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 xSvg_y3PF"><path d="M714.163 519.284 1160.89 0h-105.86L667.137 450.887 357.328 0H0l468.492 681.821L0 1226.37h105.866l409.625-476.152 327.181 476.152H1200L714.137 519.284h.026ZM569.165 687.828l-47.468-67.894-377.686-540.24h162.604l304.797 435.991 47.468 67.894 396.2 566.721H892.476L569.165 687.854v-.026Z"></path></svg></a><a href="https://github.com/dcasati" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>A network virtual appliance (NVA) is a virtual machine that performs network functions such as firewalling. In this post, I will walk you through how to use a Linux VM as an NVA in Azure and route traffic to an endpoint running on Azure Kubernetes Service (AKS). I will cover two scenarios: one where the traffic goes through an internal load balancer, and another where the traffic goes directly to a pod.</p>
<p>This assumes you already have a Linux VM and an AKS Cluster created - both in their own VNET. The cluster and the Linux VM need to be VNET peered already. <a href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-network-manage-peering?tabs=peering-cli" target="_blank" rel="noopener noreferrer" class="">Here is a quick start on VNET peering if you need a refresher</a>.</p>
<p>For this example we will be using Ubuntu 22.04. Since we have a few excellent tutorials on how to create a Linux VM on Azure I will not be describing that process here. If you need an example, <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/tutorial-manage-vm" target="_blank" rel="noopener noreferrer" class="">here&#x27;s a good one that describe the creation process using the Azure CLI</a>.</p>
<p>After your VM is created, <code>ssh</code> into it and allow IP forwarding:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-w</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">net.ipv4.ip_forward</span><span class="token operator">=</span><span class="token number">1</span><br></span></code></pre></div></div>
<p>For that change to be persistent, make sure you add it to <code>/etc/sysctl.conf</code>. Moving on, let&#x27;s look into our first scenario.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-1-nva-routing-to-a-pod-through-an-internal-load-balancer">Scenario 1: NVA routing to a pod through an internal load balancer<a href="#scenario-1-nva-routing-to-a-pod-through-an-internal-load-balancer" class="hash-link" aria-label="Direct link to Scenario 1: NVA routing to a pod through an internal load balancer" title="Direct link to Scenario 1: NVA routing to a pod through an internal load balancer" translate="no">​</a></h3>
<p><img decoding="async" loading="lazy" alt="scenario 1" src="/assets/images/scenario1-7224d454ad73fad28428d20fd9748538.jpg" width="1021" height="564" class="img_ev3q"></p>
<p>In this scenario, we will route traffic from the Linux VM to a pod in the AKS cluster through an internal load balancer. The internal load balancer will balance the traffic among the pods that match a certain label selector. The diagram below shows the network topology for this scenario:</p>
<p>To implement this scenario, we will need to do the following steps:</p>
<ul>
<li class="">Create a sample workload on the AKS cluster</li>
<li class="">Create an internal load balancer on the AKS cluster</li>
<li class="">Set up the firewall rules on the Linux VM</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-a-sample-workload">Create a sample workload<a href="#create-a-sample-workload" class="hash-link" aria-label="Direct link to Create a sample workload" title="Direct link to Create a sample workload" translate="no">​</a></h4>
<p>First, we will create a sample workload on the AKS cluster to test our traffic routing. We will use a simple Python web server that listens on port 80 and returns a hello message. We will deploy a pod that runs this web server and label it with <code>run: tmp-shell</code>. To do this, run the following commands:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Connect to the AKS cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks get-credentials --resource-group </span><span class="token operator">&lt;</span><span class="token plain">your-resource-group</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">your-aks-cluster</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Deploy a pod for testing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl run tmp-shell </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--image</span><span class="token plain"> nicolaka/netshoot </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--labels</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">run</span><span class="token operator">=</span><span class="token plain">tmp-shell</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Run a simple Python web server on port 80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-it</span><span class="token plain"> tmp-shell -- python3 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-m</span><span class="token plain"> http.server </span><span class="token number">80</span><br></span></code></pre></div></div>
<p>You should see something like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Serving HTTP on </span><span class="token number">0.0</span><span class="token plain">.0.0 port </span><span class="token number">80</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">http://0.0.0.0:80/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-an-internal-load-balancer">Create an internal load balancer<a href="#create-an-internal-load-balancer" class="hash-link" aria-label="Direct link to Create an internal load balancer" title="Direct link to Create an internal load balancer" translate="no">​</a></h4>
<p>Next, we will create an internal load balancer on the AKS cluster that will expose the pod on port <code>49180</code>. The internal load balancer will use the label selector <code>run: tmp-shell</code> to find the pod and balance the traffic among the pods that match this selector. To do this, run the following commands:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Create a service of type LoadBalancer with an annotation to make it internal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply </span><span class="token string bash punctuation parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: tmp-shell</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    service.beta.kubernetes.io/azure-load-balancer-internal: &quot;true&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: LoadBalancer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  - port: 49180</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    run: tmp-shell</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre></div></div>
<p>This will create a service named tmp-shell of type LoadBalancer with an annotation to make it internal. The service will expose port 49180 and forward the traffic to port 80 of the pod that matches the label selector <code>run: tmp-shell</code>.</p>
<p>To verify that the service is created and has an internal IP address, run the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get </span><span class="token function" style="color:rgb(80, 250, 123)">service</span><span class="token plain"> tmp-shell</span><br></span></code></pre></div></div>
<p>You should see something like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME         TYPE           CLUSTER-IP     EXTERNAL-IP    PORT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">S</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">           AGE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubernetes   ClusterIP      </span><span class="token number">10.0</span><span class="token plain">.0.1       </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">         </span><span class="token number">443</span><span class="token plain">/TCP           2d1h</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tmp-shell    LoadBalancer   </span><span class="token number">10.0</span><span class="token plain">.166.113   </span><span class="token number">10.224</span><span class="token plain">.0.222   </span><span class="token number">49180</span><span class="token plain">:30265/TCP   47h</span><br></span></code></pre></div></div>
<p>This means that the service has an internal IP address of <code>10.224.0.222</code> and is listening on port 49180.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-the-firewall">Setup the firewall<a href="#setup-the-firewall" class="hash-link" aria-label="Direct link to Setup the firewall" title="Direct link to Setup the firewall" translate="no">​</a></h4>
<p>Finally, we will set up the firewall rules on the Linux VM to route the traffic from the VM to the internal load balancer. We will use iptables to configure the firewall rules. To do this, run the following commands on the Linux VM:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> FORWARD </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-p</span><span class="token plain"> tcp </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--syn</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--dport</span><span class="token plain"> </span><span class="token number">49181</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-m</span><span class="token plain"> conntrack </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--ctstate</span><span class="token plain"> NEW </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> ACCEPT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> FORWARD </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-m</span><span class="token plain"> conntrack </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--ctstate</span><span class="token plain"> ESTABLISHED,RELATED </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> ACCEPT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-P</span><span class="token plain"> FORWARD DROP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> nat </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> PREROUTING </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-i</span><span class="token plain"> eth0 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-p</span><span class="token plain"> tcp </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--dport</span><span class="token plain"> </span><span class="token number">49181</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> DNAT --to-destination </span><span class="token number">10.224</span><span class="token plain">.0.222</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> nat </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> POSTROUTING </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> eth0 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-p</span><span class="token plain"> tcp </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--dport</span><span class="token plain"> </span><span class="token number">49181</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> </span><span class="token number">10.224</span><span class="token plain">.0.222 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> SNAT --to-source </span><span class="token number">10.3</span><span class="token plain">.0.4</span><br></span></code></pre></div></div>
<p>Explanation:</p>
<table><thead><tr><th>Rule</th><th>Notes</th></tr></thead><tbody><tr><td>iptables -A PREROUTING -i eth0 -p tcp -m tcp --dport 49181 -j DNAT --to-destination 10.224.0.222</td><td>Packet arrived on eth0 (coming from the public IP of the VM) and get&#x27;s DNAT&#x27;ed to the Internal Load Balancer private IP and to the service in AKS that will send traffic to the pod on port 80.</td></tr><tr><td>iptables -A FORWARD -p tcp -m tcp --dport 49181 -m conntrack --ctstate NEW -j ACCEPT</td><td>Allow forwarding on port 49181.</td></tr><tr><td>iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</td><td>Match any packet that is related to an existing connection, using the conntrack module. This is necessary to allow the established and related connections to the internal service.</td></tr><tr><td>iptables -P FORWARD DROP</td><td>Set the policy to drop packets in the FORWARD chain. This means, unless specified (see line above) we will drop traffic.</td></tr><tr><td>iptables -A POSTROUTING -d 10.224.0.222/32 -o eth0 -p tcp -m tcp --dport 49181 -j SNAT --to-source 10.3.0.4</td><td>Send traffic to the Internal Load Balancer on port 49181. SNAT the source IP with the private IP of the firewall (10.3.0.4).</td></tr></tbody></table>
<p>At this point in time, our rules are in place but they will not persist a reboot. To make sure the Firewall loads these rules on boot time we need to install the <code>iptables-persistent</code> package:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">apt</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> iptables-persistent</span><br></span></code></pre></div></div>
<p>Once that&#x27;s installed, save your current configuration so iptables-persistent can load them during boot time:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> iptables-save </span><span class="token operator">&gt;</span><span class="token plain"> /etc/iptables/rules.v4</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-2-nva-routing-directly-to-a-pod">Scenario 2: NVA routing directly to a pod<a href="#scenario-2-nva-routing-directly-to-a-pod" class="hash-link" aria-label="Direct link to Scenario 2: NVA routing directly to a pod" title="Direct link to Scenario 2: NVA routing directly to a pod" translate="no">​</a></h3>
<p>In this second scenario, we will route traffic from the Linux VM directly to a pod in the AKS cluster without going through an internal load balancer. The diagram below shows the network topology for this scenario:</p>
<p><img decoding="async" loading="lazy" alt="scenario 2" src="/assets/images/scenario2-1a85bc5a64a9b225b36d9e842d090703.jpg" width="965" height="533" class="img_ev3q"></p>
<p>To implement this scenario, we will need to do the following steps:</p>
<ul>
<li class="">Create a sample workload on the AKS cluster. Follow the steps described earlier to the deploy the POD using <code>netshoot</code> as your base image. You do not need to deploy the Internal Load Balancer as we will not be using it for this scenario.</li>
<li class="">Set up the firewall rules on the Linux VM</li>
</ul>
<p>The new firewall rules are:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> FORWARD </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-p</span><span class="token plain"> tcp </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--syn</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--dport</span><span class="token plain"> </span><span class="token number">80</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-m</span><span class="token plain"> conntrack </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--ctstate</span><span class="token plain"> NEW </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> ACCEPT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> FORWARD </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-m</span><span class="token plain"> conntrack </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--ctstate</span><span class="token plain"> ESTABLISHED,RELATED </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> ACCEPT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-P</span><span class="token plain"> FORWARD DROP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> nat </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> PREROUTING </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-i</span><span class="token plain"> eth0 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-p</span><span class="token plain"> tcp </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--dport</span><span class="token plain"> </span><span class="token number">49181</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> DNAT --to-destination </span><span class="token number">10.224</span><span class="token plain">.0.118:80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">iptables </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-t</span><span class="token plain"> nat </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-A</span><span class="token plain"> POSTROUTING </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> eth0 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-p</span><span class="token plain"> tcp </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--dport</span><span class="token plain"> </span><span class="token number">80</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> </span><span class="token number">10.224</span><span class="token plain">.0.118 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-j</span><span class="token plain"> SNAT --to-source </span><span class="token number">10.3</span><span class="token plain">.0.4</span><br></span></code></pre></div></div>
<p>Explanation:</p>
<table><thead><tr><th>Rule</th><th>Notes</th></tr></thead><tbody><tr><td>iptables -A PREROUTING -i eth0 -p tcp -m tcp --dport 49181 -j DNAT --to-destination 10.224.0.118:80</td><td>Packet arrived on eth0 (coming from the public IP of the VM) and get&#x27;s DNAT&#x27;ed to the POD private IP on port 80.</td></tr><tr><td>iptables -A FORWARD -p tcp -m tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT</td><td>At this point, the original packets are now going to be send to port 80. This rule allows that flow.</td></tr><tr><td>iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</td><td>Match any packet that is related to an existing connection, using the conntrack module. This is necessary to allow the established and related connections to the internal service.</td></tr><tr><td>iptables -P FORWARD DROP</td><td>Set the policy to drop packets in the FORWARD chain. This means, unless specified (see line above) we will drop traffic.</td></tr><tr><td>iptables -A POSTROUTING -d 10.224.0.118/32 -o eth0 -p tcp -m tcp --dport 80 -j SNAT --to-source 10.3.0.4</td><td>The last rule before the packet leaves the kernel, we run a Source NAT (SNAT) and add the Firewall private IP so the pod knows where to return this packet to. Once that packet hits the firewall, we can return it to the sender on the Internet.</td></tr></tbody></table>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing-and-validating">Testing and validating<a href="#testing-and-validating" class="hash-link" aria-label="Direct link to Testing and validating" title="Direct link to Testing and validating" translate="no">​</a></h4>
<p>To test and verify that the port forwarding rules are working - for both scenarios - you can use a tool like telnet or curl to connect to the external port 49181 from another host. You should see the response from the internal service on port 80. For example, the following command will send a HTTP request to the external port 49181 and display the response:</p>
<table><thead><tr><th>Test case</th><th>Target</th><th>Note</th></tr></thead><tbody><tr><td>From the firewall to the pod</td><td><code>curl http://${POD_IP_ADDRESS}</code></td><td>Pod listens on port 80</td></tr><tr><td>From the Internet to the public IP of the firewall</td><td><code>curl http://${PUBLIC_IP}:49181</code></td><td>This connection will be DNATed to proper endpoint (pod or ILB)</td></tr></tbody></table>
<p>You should see something like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">tmp-shell:~</span><span class="token comment" style="color:rgb(98, 114, 164)"># python3 -m http.server 80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Serving HTTP on </span><span class="token number">0.0</span><span class="token plain">.0.0 port </span><span class="token number">80</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">http://0.0.0.0:80/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">10.3</span><span class="token plain">.0.4 - - </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">02/Feb/2024 </span><span class="token number">20</span><span class="token plain">:50:32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">10.3</span><span class="token plain">.0.4 - - </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">02/Feb/2024 </span><span class="token number">20</span><span class="token plain">:50:33</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">10.3</span><span class="token plain">.0.4 - - </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">02/Feb/2024 </span><span class="token number">20</span><span class="token plain">:50:34</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">10.3</span><span class="token plain">.0.4 - - </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">02/Feb/2024 </span><span class="token number">20</span><span class="token plain">:50:35</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;GET / HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> -</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h3>
<p>In this article we&#x27;ve explored how create your own - basic - network virtual appliance and route traffic to an AKS cluster. from here, you can take this as a base for more complex and custom examples. Good luck !</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/appdevgbb/gbb-blog/tree/main/docusaurus/blog/2024-02-02/securing-your-aks-cluster-with-a-linux-firewall-vm/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2024/03/05/workload-identity-kv-csi"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Using the Azure Key Vault CSI Driver with Workload Identity</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2023/12/19/workload-identity-blob-example"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Using Workload Idenity to Access Azure Blob Storage</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#scenario-1-nva-routing-to-a-pod-through-an-internal-load-balancer" class="table-of-contents__link toc-highlight">Scenario 1: NVA routing to a pod through an internal load balancer</a></li><li><a href="#scenario-2-nva-routing-directly-to-a-pod" class="table-of-contents__link toc-highlight">Scenario 2: NVA routing directly to a pod</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Posts</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/gbb-blog">Posts</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/appdevgbb" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://learn.microsoft.com/azure/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Microsoft Learn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://azure.microsoft.com/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Azure Blog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/stevegriffith" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 App Innovation Global Blackbelt. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>