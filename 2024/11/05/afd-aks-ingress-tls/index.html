<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">End to End TLS Encryption with AKS and AFD | Azure Global Blackbelt</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://azureglobalblackbelts.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://azureglobalblackbelts.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://azureglobalblackbelts.com/2024/11/05/afd-aks-ingress-tls"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="End to End TLS Encryption with AKS and AFD | Azure Global Blackbelt"><meta data-rh="true" name="description" content="Using Azure Front Door in-front of an in-cluster nginx ingress controller to provide end-to-end TLS encryption of application traffic."><meta data-rh="true" property="og:description" content="Using Azure Front Door in-front of an in-cluster nginx ingress controller to provide end-to-end TLS encryption of application traffic."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-11-05T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/swgriffith"><link data-rh="true" rel="icon" href="/img/gbb.png"><link data-rh="true" rel="canonical" href="https://azureglobalblackbelts.com/2024/11/05/afd-aks-ingress-tls"><link data-rh="true" rel="alternate" href="https://azureglobalblackbelts.com/2024/11/05/afd-aks-ingress-tls" hreflang="en"><link data-rh="true" rel="alternate" href="https://azureglobalblackbelts.com/2024/11/05/afd-aks-ingress-tls" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://azureglobalblackbelts.com/2024/11/05/afd-aks-ingress-tls","mainEntityOfPage":"https://azureglobalblackbelts.com/2024/11/05/afd-aks-ingress-tls","url":"https://azureglobalblackbelts.com/2024/11/05/afd-aks-ingress-tls","headline":"End to End TLS Encryption with AKS and AFD","name":"End to End TLS Encryption with AKS and AFD","description":"Using Azure Front Door in-front of an in-cluster nginx ingress controller to provide end-to-end TLS encryption of application traffic.","datePublished":"2024-11-05T00:00:00.000Z","author":{"@type":"Person","name":"Steve Griffith","description":"Principal Cloud Architect, Azure Global Black Belt","url":"https://github.com/swgriffith","image":"https://github.com/swgriffith.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://azureglobalblackbelts.com/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Azure Global Blackbelt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Azure Global Blackbelt Atom Feed"><link rel="stylesheet" href="/assets/css/styles.5718cfe7.css">
<script src="/assets/js/runtime~main.b4103c26.js" defer="defer"></script>
<script src="/assets/js/main.67e1397c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/gbb.png"><link rel="preload" as="image" href="https://github.com/swgriffith.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/gbb.png" alt="Azure Global Blackbelt Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/gbb.png" alt="Azure Global Blackbelt Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Azure Global Blackbelt</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/appdevgbb" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/07/02/when-infrastructure-scales-but-understanding-doesnt">When Infrastructure Scales But Understanding Doesn&#x27;t</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/06/24/human-scale-problem-in-platform-engineering">The Human Scale Problem in Platform Engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/01/31/updating-aks-network-plugin-from-kubenet-to-azure-cni">Updating AKS Network Plugin from Kubenet to Azure CNI</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/2024/11/05/afd-aks-ingress-tls">End to End TLS Encryption with AKS and AFD</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/09/06/multi-cluster-layer-4-load-balancing-with-fleet-manager">Multi-Cluster Layer 4 Load Balancing with Fleet Manager</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/08/15/aks-control-plane-log-filtering">Using Stream Analytics to Filter AKS Control Plane Logs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/04/16/aks-kaito">Using Project KAITO in AKS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/03/05/workload-identity-kv-csi">Using the Azure Key Vault CSI Driver with Workload Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm">Securing your AKS cluster with a Linux Firewall VM</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/12/19/workload-identity-blob-example">Using Workload Idenity to Access Azure Blob Storage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/12/18/external-dns-workload-identity">Using External DNS in AKS with Azure Workload Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/27/capabilities-in-aks">Using Linux Capabilities in AKS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/09/part1-notation-usage">Image Verification Part 1 - Notation CLI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/09/part2-aks-image-verification">Image Verification Part 2 - Image Verification with Gatekeeper and Ratify</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/10/26/aks-custom-policy">AKS Custom Policy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/10/12/aks-user-min-roles">AKS User Minimum Roles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/agc-egress-lockdown">Using App Gateway for Containers with Egress Lockdown</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/kubelogin-terraform">Using Kubelogin with AKS via Terraform</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/workload-identity-example">Workload Identity</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-azuresql-example">Accessing Azure SQL DB via Workload Identity and Managed Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-self-managed-setup">Using Workload Identity with Self Managed Clusters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-windows-example">Workload Identity - Windows Nodepool Walkthrough</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">End to End TLS Encryption with AKS and AFD</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-11-05T00:00:00.000Z">November 5, 2024</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/swgriffith" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/swgriffith.png" alt="Steve Griffith"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/swgriffith" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp" translate="no">Steve Griffith</span></a></div><small class="authorTitle_nd0D" title="Principal Cloud Architect, Azure Global Black Belt">Principal Cloud Architect, Azure Global Black Belt</small><div class="authorSocials_rSDt"><a href="https://x.com/SteveGriffith" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="X"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 1200 1227" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 xSvg_y3PF"><path d="M714.163 519.284 1160.89 0h-105.86L667.137 450.887 357.328 0H0l468.492 681.821L0 1226.37h105.866l409.625-476.152 327.181 476.152H1200L714.137 519.284h.026ZM569.165 687.828l-47.468-67.894-377.686-540.24h162.604l304.797 435.991 47.468 67.894 396.2 566.721H892.476L569.165 687.854v-.026Z"></path></svg></a><a href="https://github.com/swgriffith" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" translate="no">​</a></h2>
<p>In this walkthrough we&#x27;ll create deploy an app with end to end TLS encryption, using Azure Front Door as the Internet Facing TLS endpoint and an Nginx Ingress controller running inside an AKS cluster as the backend.</p>
<p>We&#x27;ll use Azure Key Vault to store the TLS certificate, and will use the Key Vault CSI Driver to get the secrets into the ingress controller. The Key Vault CSI Driver will use Azure Workload Identity to safely retrieve the certificate.</p>
<p>Let&#x27;s get to it....</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="network-setup">Network Setup<a href="#network-setup" class="hash-link" aria-label="Direct link to Network Setup" title="Direct link to Network Setup" translate="no">​</a></h2>
<p>First, we&#x27;ll need to establish the network where our AKS cluster will be deployed. Nothing special in our network design, other than the fact that I&#x27;m creating an Azure Network Security Group at the subnet level for added security.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Resource Group Creation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">RG</span><span class="token operator">=</span><span class="token plain">E2ETLSLab</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">LOC</span><span class="token operator">=</span><span class="token plain">eastus2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the Resource Group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az group create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-l</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$LOC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the resource group id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">RG_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az group show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Set an environment variable for the VNet name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">VNET_NAME</span><span class="token operator">=</span><span class="token plain">lablab-vnet</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">VNET_ADDRESS_SPACE</span><span class="token operator">=</span><span class="token number">10.140</span><span class="token plain">.0.0/16</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AKS_SUBNET_ADDRESS_SPACE</span><span class="token operator">=</span><span class="token number">10.140</span><span class="token plain">.0.0/24</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create an NSG at the subnet level for security reasons</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az network nsg create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> aks-subnet-nsg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the NSG ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">NSG_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az network nsg show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> aks-subnet-nsg </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the Vnet along with the initial subet for AKS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az network vnet create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VNET_NAME</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--address-prefix </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VNET_ADDRESS_SPACE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--subnet-name aks </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--subnet-prefix </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AKS_SUBNET_ADDRESS_SPACE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--network-security-group aks-subnet-nsg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get a subnet resource ID, which we&#x27;ll need when we create the AKS cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">VNET_SUBNET_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az network vnet subnet show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG --vnet-name $VNET_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> aks </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="cluster-creation">Cluster Creation<a href="#cluster-creation" class="hash-link" aria-label="Direct link to Cluster Creation" title="Direct link to Cluster Creation" translate="no">​</a></h2>
<p>Now, lets create the AKS cluster where our workload and ingress controller will reside. This will be a very plain AKS cluster, however we will deploy to our above created subnet and will enable the following features:</p>
<ul>
<li class=""><em>Workload Identity:</em> This will be used by the Key Vault CSI Driver to retrieve the cluster certificate</li>
<li class=""><em>OIDC Issuer:</em> This is required by Workload Identity to be used during service account fedration</li>
<li class=""><em>Key Vault CSI Driver:</em> This will be used to retrieve the cluster certificate</li>
</ul>
<blockquote>
<p><em>Note:</em> Since I created a NSG at the subnet level, I&#x27;ll need to create a custom role which will be used later for automated private link creation. If you don&#x27;t have an NSG on the subnet, and just rely on the managed NSG that AKS owns, then you don&#x27;t need to create the custom role documented below.</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># NOTE: Make sure you give your cluster a unique name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token operator">=</span><span class="token plain">e2etlslab</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Cluster Creation Command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CLUSTER_NAME</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--node-count </span><span class="token number">2</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--enable-oidc-issuer </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--enable-workload-identity </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--enable-addons azure-keyvault-secrets-provider </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--vnet-subnet-id </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$VNET_SUBNET_ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the cluster identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_IDENTITY</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $CLUSTER_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> identity.principalId</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">###################################################################################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Grant the cluster identity rights on the cluster nsg, which we&#x27;ll need later when we create the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># private link.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># NOTE: These steps are only needed if you have a custom NSG on the cluster subnet.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the role definition file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">&gt;</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> pl-nsg-role.json</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &quot;Name&quot;: &quot;Private Link AKS Role&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &quot;Description&quot;: &quot;Grants the cluster rights on the NSG for Private Link Creation&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &quot;Actions&quot;: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &quot;Microsoft.Network/networkSecurityGroups/join/action&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &quot;NotActions&quot;: [],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &quot;DataActions&quot;: [],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &quot;NotDataActions&quot;: [],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    &quot;assignableScopes&quot;: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        &quot;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${RG_ID}</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the role definition in Azure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az role definition create --role-definition @pl-nsg-role.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Assign the role</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># NOTE: New role propegation may take a minute or to, so retry as needed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az role assignment create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--role</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Private Link AKS Role&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--assignee</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CLUSTER_IDENTITY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--scope</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$NSG_ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">###################################################################################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks get-credentials </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CLUSTER_NAME</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-workload-identity">Setup Workload Identity<a href="#setup-workload-identity" class="hash-link" aria-label="Direct link to Setup Workload Identity" title="Direct link to Setup Workload Identity" translate="no">​</a></h2>
<p>Now that we have our cluster, lets finish setting up the workload identity that will be used to retrieve our certificate from Azure Key Vault.</p>
<blockquote>
<p><em>Note:</em> For simplicity, I&#x27;m keeping all resources in the &#x27;default&#x27; namespace. You may want to modify this for your own deployment.</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Set the namespace where we will deploy our app and ingress controller</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">NAMESPACE</span><span class="token operator">=</span><span class="token plain">default</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the OIDC Issuer URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AKS_OIDC_ISSUER</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show </span><span class="token string variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic"> $CLUSTER_NAME </span><span class="token string variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG </span><span class="token string variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token string variable string" style="color:rgb(255, 121, 198);font-style:italic">&quot;oidcIssuerProfile.issuerUrl&quot;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token string variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-otsv</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the Tenant ID for later</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">IDENTITY_TENANT</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az account show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tenantId</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the managed identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az identity create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> nginx-ingress-identity --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--location</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$LOC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get identity client ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">USER_ASSIGNED_CLIENT_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az identity show --resource-group $RG </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> nginx-ingress-identity </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&#x27;clientId&#x27;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a service account to federate with the managed identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply </span><span class="token string bash punctuation parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: ServiceAccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    azure.workload.identity/client-id: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${USER_ASSIGNED_CLIENT_ID}</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    azure.workload.identity/use: &quot;true&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: nginx-ingress-sa</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  namespace: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${NAMESPACE}</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Federate the identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az identity federated-credential create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> nginx-ingress-federated-id </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--identity-name nginx-ingress-identity </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--issuer</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${AKS_OIDC_ISSUER}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--subject</span><span class="token plain"> system:serviceaccount:</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${NAMESPACE}</span><span class="token plain">:nginx-ingress-sa</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-the-azure-key-vault-and-upload-certificate">Create the Azure Key Vault and Upload Certificate<a href="#create-the-azure-key-vault-and-upload-certificate" class="hash-link" aria-label="Direct link to Create the Azure Key Vault and Upload Certificate" title="Direct link to Create the Azure Key Vault and Upload Certificate" translate="no">​</a></h2>
<p>Now, lets create our Azure Key Vault and then create and upload our certificate.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Create a key vault name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">KEY_VAULT_NAME</span><span class="token operator">=</span><span class="token plain">e2elab</span><span class="token environment constant" style="color:rgb(189, 147, 249)">$RANDOM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the key vaule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az keyvault create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KEY_VAULT_NAME</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--location</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$LOC</span><span class="token plain"> --enable-rbac-authorization </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Grant access to the secret for the managed identity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az keyvault set-policy </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KEY_VAULT_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> --certificate-permissions get </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--spn</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${USER_ASSIGNED_CLIENT_ID}</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az keyvault set-policy </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KEY_VAULT_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> --secret-permissions get </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--spn</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${USER_ASSIGNED_CLIENT_ID}</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><br></span></code></pre></div></div>
<p>For certificate creation, I actually took two separate paths.</p>
<ul>
<li class=""><em>Option 1:</em> Use Azure <a href="https://learn.microsoft.com/en-us/azure/app-service/configure-ssl-app-service-certificate?tabs=portal" target="_blank" rel="noopener noreferrer" class="">App Service Certificates</a> to create and manage the certificate.</li>
<li class=""><em>Option 2:</em> Use &#x27;<a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer" class="">LetsEncrypt</a>&#x27; and <a href="https://certbot.eff.org/" target="_blank" rel="noopener noreferrer" class="">Certbot</a> to create the certificate.</li>
</ul>
<p>Both options are totally fine, but have slight differences in approach, which I&#x27;ll highlight below. If you&#x27;re working in a large enterprise, you&#x27;ll likely have a completely separate internal process for getting a certificate. In the end, all we care about is that we have a valid cert and key file.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="option-1-app-service-certificates">Option 1: App Service Certificates<a href="#option-1-app-service-certificates" class="hash-link" aria-label="Direct link to Option 1: App Service Certificates" title="Direct link to Option 1: App Service Certificates" translate="no">​</a></h3>
<p>We won&#x27;t cover all the details of setting up a certificate with App Service Certificates, but you can review the doc <a href="https://learn.microsoft.com/en-us/azure/app-service/configure-ssl-app-service-certificate?tabs=portal" target="_blank" rel="noopener noreferrer" class="">here</a> for those steps.</p>
<p>When I created the certificate, I told App Svc Certs to store the cert in the Key Vault just created. We&#x27;ll use the <a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver" target="_blank" rel="noopener noreferrer" class="">Key Vault CSI Driver</a> to mount the certificate into the ingress controller, but to do that we need to get the certficate into a format that the CSI driver can read. App Svc Certs stores the certificate in an Azure Key Vault in pfx format as a secret, but for the Key Vault CSI Driver we need it stored as a certificate. We can export the PFX from the Azure Key Vault Secret and then import it as a certificate.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">APP_CERT_NAME</span><span class="token operator">=</span><span class="token plain">e2elab</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the secret name for the certificate in key vault</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SECRET_NAME</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az resource show --resource-group $RG --resource-type </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&quot;Microsoft.CertificateRegistration/certificateOrders&quot;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $APP_CERT_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&quot;properties.certificates.</span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$APP_CERT_NAME</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">.keyVaultSecretName&quot;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--output</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Download the certificate </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az keyvault secret download </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--file</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$APP_CERT_NAME</span><span class="token plain">.pfx --vault-name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KEY_VAULT_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SECRET_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--encoding</span><span class="token plain"> base64</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import the certificate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az keyvault certificate </span><span class="token function" style="color:rgb(80, 250, 123)">import</span><span class="token plain"> --vault-name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KEY_VAULT_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$APP_CERT_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--file</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$APP_CERT_NAME</span><span class="token plain">.pfx</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="option-2-letsencryptcertbot">Option 2: LetsEncrypt/CertBot<a href="#option-2-letsencryptcertbot" class="hash-link" aria-label="Direct link to Option 2: LetsEncrypt/CertBot" title="Direct link to Option 2: LetsEncrypt/CertBot" translate="no">​</a></h3>
<p>I&#x27;m not going to get into all the specifics of using Certbot with LetsEncrypt, but the basic are as follows. The domain I&#x27;ll be using is my &#x27;crashoverride.nyc&#x27; domain.</p>
<ol>
<li class="">Get an internet reachable host capable of running a webserver on ports 80 and 443</li>
<li class="">Create an A-record for your target domain to the public IP of the server. This is required for hostname validation used by Certbot</li>
<li class="">Run the certbot command as a priviledged user on that web server host mentioned in #1 above</li>
</ol>
<p>Here&#x27;s a sample of the command I used to create a cert with two entries in the certificate Subject Alternate Names:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> certbot certonly --key-type rsa </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--standalone</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> e2elab.crashoverride.nyc </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-d</span><span class="token plain"> www.crashoverride.nyc</span><br></span></code></pre></div></div>
<p>Certbot creates several files, all with the PEM file extension. This is misleading, as fullchain.pem is the &#x27;crt&#x27; file and the privkey.pem is the &#x27;key&#x27; file. To store these in Azure Key Vault as certs we&#x27;ll need to package these files up in a PFX format.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">APP_CERT_NAME</span><span class="token operator">=</span><span class="token plain">crashoverride</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># export to pfx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># skipping the Password prompt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">openssl pkcs12 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-export</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-passout</span><span class="token plain"> pass: </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-in</span><span class="token plain"> fullchain.pem </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-inkey</span><span class="token plain"> privkey.pem  </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-out</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${APP_CERT_NAME}</span><span class="token plain">.pfx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Import the certificate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az keyvault certificate </span><span class="token function" style="color:rgb(80, 250, 123)">import</span><span class="token plain"> --vault-name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$KEY_VAULT_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$APP_CERT_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--file</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$APP_CERT_NAME</span><span class="token plain">.pfx</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="set-up-the-key-vault-csi-secret-provider-class">Set up the Key Vault CSI Secret Provider Class<a href="#set-up-the-key-vault-csi-secret-provider-class" class="hash-link" aria-label="Direct link to Set up the Key Vault CSI Secret Provider Class" title="Direct link to Set up the Key Vault CSI Secret Provider Class" translate="no">​</a></h2>
<p>Great! Now we have our network, cluster, key vault and secrets ready to go. We can now create our SecretProviderClass, which is the link between our Kubernetes resources and the secret in Azure Key Vault. We&#x27;ll actually use this SecretProviderClass to mount the certificate into our ingress controller.</p>
<blockquote>
<p><em>Note:</em> The Key Vault CSI driver uses the Kubernetes Container Storage Interface to initiate it&#x27;s connection to Key Vault. That means, even though we really only care about having the certificate as a Kubernetes secret for use in our ingress definition, we still need to mount the secret as a volume to create the Kubernetes Secret. We&#x27;ll mount the certificate secret to the ingress controller, but you could mount it to your app alternatively, especially if you plan to use the certificate in your app directly as well.</p>
</blockquote>
<p>When you create a certificate in Azure Key Vault and then use the Key Vault CSI driver to access that certificate, you use the &#x27;secret&#x27; object type and the certificate name. The returned secret contains the certificate key and crt file using the names tls.key and tls.crt.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># We&#x27;ll cat the SecretProviderClass direclty into kubectl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># You could also just cat it out to a file and use that file to deploy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply </span><span class="token string bash punctuation parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: secrets-store.csi.x-k8s.io/v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: SecretProviderClass</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: crashoverride-tls</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  namespace: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${NAMESPACE}</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  provider: azure</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  secretObjects:                            # secretObjects defines the desired state of synced K8s secret objects</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    - secretName: crashoverride-tls-csi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      type: kubernetes.io/tls</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      data: </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - objectName: crashoverride</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          key: crashoverride.key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - objectName: crashoverride</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          key: crashoverride.crt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  parameters:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    usePodIdentity: &quot;false&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    clientID: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${USER_ASSIGNED_CLIENT_ID}</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    keyvaultName: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${KEY_VAULT_NAME}</span><span class="token string" style="color:rgb(255, 121, 198)">                 # the name of the AKV instance</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    objects: |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      array:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          objectName: crashoverride</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          objectType: secret</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    tenantId: </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${IDENTITY_TENANT}</span><span class="token string" style="color:rgb(255, 121, 198)">                    # the tenant ID of the AKV instance</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deploy-the-ingress-controller">Deploy the Ingress Controller<a href="#deploy-the-ingress-controller" class="hash-link" aria-label="Direct link to Deploy the Ingress Controller" title="Direct link to Deploy the Ingress Controller" translate="no">​</a></h2>
<p>Now we&#x27;re ready to create our ingress controller. For our purposes, and for it&#x27;s simplicity, we&#x27;re going to use ingress-nginx. The approach will be roughly the same for any ingress controller.</p>
<p>There are a few key points to note in the deployment below.</p>
<ol>
<li class="">We want our ingress controller to be on an internal network with no public IP, since Azure Front Door will provide the public endpoint. To do that we&#x27;ll need to apply the &#x27;azure-load-balancer-internal&#x27; annotation.</li>
<li class="">Azure Front Door can only connect to a private IP address using an Azure Private Link Service. Fortunately, AKS provides the &#x27;azure-pls-create&#x27; annotation which will automatically create and manage a private link for you.</li>
<li class="">As mentioned above, since we&#x27;re using the Key Vault CSI Driver, we need to mount the Secret Provider Class using the secret-store driver.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">helm repo </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Generate the values file we&#x27;ll use to deploy ingress-nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">&gt;</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> nginx-ingress-values.yaml</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">serviceAccount:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  create: false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: nginx-ingress-sa</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">controller:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  replicaCount: 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  service:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      service.beta.kubernetes.io/azure-load-balancer-internal: &quot;true&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      service.beta.kubernetes.io/azure-pls-create: &quot;true&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  extraVolumes:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      - name: crashoverride-secret-store</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        csi:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          driver: secrets-store.csi.k8s.io</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          readOnly: true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          volumeAttributes:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">            secretProviderClass: &quot;crashoverride-tls&quot;            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  extraVolumeMounts:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      - name: crashoverride-secret-store</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        mountPath: &quot;/mnt/crashoverride&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        readOnly: true        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Deploy ingress-nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">helm </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> e2elab-ic ingress-nginx/ingress-nginx </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--namespace</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$NAMESPACE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token plain"> nginx-ingress-values.yaml</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deploy-a-sample-app">Deploy a Sample App<a href="#deploy-a-sample-app" class="hash-link" aria-label="Direct link to Deploy a Sample App" title="Direct link to Deploy a Sample App" translate="no">​</a></h2>
<p>We&#x27;ll need a sample app to test our configuration. I personally like the &#x27;<a href="https://github.com/cilium/echoserver" target="_blank" rel="noopener noreferrer" class="">echoserver</a>&#x27; app from the cilium team. It&#x27;s nice, as it returns the HTTP headers as the web response, which can be very useful in http request testing.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> </span><span class="token string bash punctuation operator" style="color:rgb(248, 248, 242)">|</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> kubectl apply </span><span class="token string bash punctuation parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token string bash punctuation" style="color:rgb(248, 248, 242)"> -</span><span class="token string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Deployment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: aks-helloworld </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  replicas: 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    matchLabels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      app: aks-helloworld</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  template:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      labels:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        app: aks-helloworld</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      containers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      - name: aks-helloworld</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        image: cilium/echoserver</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - containerPort: 8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        env:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">        - name: PORT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">          value: &#x27;8080&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">kind: Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  name: aks-helloworld</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  type: ClusterIP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  - port: 8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">    app: aks-helloworld</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">EOF</span><br></span></code></pre></div></div>
<p>Now we can deploy the ingress defintion. Look out for the following:</p>
<ol>
<li class="">The &#x27;tls&#x27; section maps the inbound TLS request to the appropriate certificate secret</li>
<li class="">The &#x27;rules&#x27; section maps the target host name to the backend service that should be targetted</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token plain">EOF</span><span class="token operator">|</span><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-f</span><span class="token plain"> -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: crashoverride-ingress-tls</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nginx.ingress.kubernetes.io/use-regex: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nginx.ingress.kubernetes.io/rewrite-target: /</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ingressClassName: nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - hosts:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - e2elab.crashoverride.nyc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    secretName: crashoverride-tls-csi </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - host: e2elab.crashoverride.nyc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    http:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - path: /hello-world</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pathType: Prefix</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        backend:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          service:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name: aks-helloworld</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            port:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              number: </span><span class="token number">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">EOF</span><br></span></code></pre></div></div>
<p>Since we haven&#x27;t set up the Azure Front Door yet, we cant access the app on the public IP yet. We can fake this out, however, with some curl magic. curl lets you call a local endpoint and pretend like you&#x27;re connecting to a different host name. We&#x27;ll need this for our ingress certificate to work.</p>
<p>First we port-forward and then we&#x27;ll curl with some special options.</p>
<blockquote>
<p><em>Note:</em> If you prefer, you can also just edit your local &#x27;hosts&#x27; file to fake out the DNS lookup. Just create an entry that maps your local loopback address (127.0.0.1) to your DNS name.</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># In terminal 1, port-forward to the ingress nginx service name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl port-forward svc/e2elab-ic-ingress-nginx-controller </span><span class="token number">8443</span><span class="token plain">:443</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># In terminal 2 run a curl like the following, changing out for your host name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-v</span><span class="token plain"> https://e2elab.crashoverride.nyc/hello-world --connect-to e2elab.crashoverride.nyc:443:127.0.0.1:8443</span><br></span></code></pre></div></div>
<p>You should have seen a successful TLS handshake with your certificate and proper hostname.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">* Server certificate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">*  subject: </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CN</span><span class="token operator">=</span><span class="token plain">e2elab.crashoverride.nyc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">*  start date: Oct </span><span class="token number">31</span><span class="token plain"> </span><span class="token number">16</span><span class="token plain">:35:44 </span><span class="token number">2024</span><span class="token plain"> GMT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">*  expire date: Jan </span><span class="token number">29</span><span class="token plain"> </span><span class="token number">16</span><span class="token plain">:35:43 </span><span class="token number">2025</span><span class="token plain"> GMT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">*  subjectAltName: </span><span class="token function" style="color:rgb(80, 250, 123)">host</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;e2elab.crashoverride.nyc&quot;</span><span class="token plain"> matched cert</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;s &quot;e2elab.crashoverride.nyc&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">*  issuer: C=US; O=Let&#x27;</span><span class="token plain">s Encrypt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CN</span><span class="token operator">=</span><span class="token plain">R10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">*  SSL certificate verify ok.</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-the-azure-front-door">Create the Azure Front Door<a href="#create-the-azure-front-door" class="hash-link" aria-label="Direct link to Create the Azure Front Door" title="Direct link to Create the Azure Front Door" translate="no">​</a></h2>
<p>Now that the backend is working, lets wire up the Azure Front Door.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Create the Azure Front Door</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az afd profile create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--profile-name e2elab </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--sku</span><span class="token plain"> Premium_AzureFrontDoor</span><br></span></code></pre></div></div>
<p>We&#x27;ll do the rest in the Azure Portal, so open a browser to <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer" class="">https://portal.azure.com</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="link-the-certificate-to-the-afd">Link the certificate to the AFD.<a href="#link-the-certificate-to-the-afd" class="hash-link" aria-label="Direct link to Link the certificate to the AFD." title="Direct link to Link the certificate to the AFD." translate="no">​</a></h3>
<p>To use our certificate with Azure Front Door, we need to attach the certificate in Azure Key Vault to an Front Door Secret. We do this in the &#x27;Secrets&#x27; pane under &#x27;Security&#x27;.</p>
<p><img decoding="async" loading="lazy" alt="link certificate" src="/assets/images/linkcert-aefeafab109f97330d25e8bdb2a7f4da.jpg" width="1514" height="820" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-the-custom-domain-configuration">Create the Custom Domain Configuration<a href="#create-the-custom-domain-configuration" class="hash-link" aria-label="Direct link to Create the Custom Domain Configuration" title="Direct link to Create the Custom Domain Configuration" translate="no">​</a></h3>
<p>Now we tell AFD what domain we&#x27;d like to use and link that domain name to the associated secret that we just created for our certificate.</p>
<p><img decoding="async" loading="lazy" alt="afd add domain 1" src="/assets/images/afd-adddomain1-d2c537a5bdcdeb7f3e901d1bf50d8da2.jpg" width="826" height="499" class="img_ev3q"></p>
<p>Next we select the appropriate secret for our domain.</p>
<p><img decoding="async" loading="lazy" alt="afd add domain 2" src="/assets/images/afd-adddomain2-b9ed436d9cc4feddaefa36690b784893.jpg" width="1240" height="826" class="img_ev3q"></p>
<p>Finally, we see the domain entry created and pending association with an endpoint.</p>
<p><img decoding="async" loading="lazy" alt="afd add domain 3" src="/assets/images/afd-adddomain3-0a8251c81e3a5d6d33d6dd87d4016bcc.jpg" width="1517" height="324" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-the-origin-group">Create the Origin Group<a href="#create-the-origin-group" class="hash-link" aria-label="Direct link to Create the Origin Group" title="Direct link to Create the Origin Group" translate="no">​</a></h3>
<p>Front Door is acting as the entry point to our backend, which is referred to as the &#x27;Origin&#x27;.</p>
<p>Creating the origin group is a two step process. You create the origin group, but as part of that you also add the origin hostname configuration. As part of that origin hostname setup you will check the &#x27;Enable Private Link Service&#x27; option, which will allow you to select the private link that was automatically created by AKS for your ingress-nginx deployment. This is why the service annotation was so important when you deployed ingress-nginx.</p>
<p>You&#x27;ll provide a message that will show up on the private link approval side. This message can be whatever you want.</p>
<p><img decoding="async" loading="lazy" alt="origin setup 1" src="/assets/images/origin-setup1-ccba7b8a83371b1b42ea8395b4d40173.jpg" width="1542" height="1054" class="img_ev3q"></p>
<p>Now we complete our origin setup, making sure to set the right path to our ingress health probe. In our case, the URL will forward to &#x27;/hello-world&#x27;, as we know this will return an HTTP 200 response. If you have your own health endpoint, you can set that here.</p>
<p><img decoding="async" loading="lazy" alt="origin setup 2" src="/assets/images/origin-setup2-2f7dcaf794d0a289b31aca9b72ee361b.jpg" width="1552" height="1045" class="img_ev3q"></p>
<p>Now we see that our origin is created, but still pending association with an endpoint.</p>
<p><img decoding="async" loading="lazy" alt="origin setup 3" src="/assets/images/origin-setup3-b13fef5f35c4a4a367f3b6d2f6d179a0.jpg" width="1561" height="502" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-the-afd-endpoint">Create the AFD Endpoint<a href="#create-the-afd-endpoint" class="hash-link" aria-label="Direct link to Create the AFD Endpoint" title="Direct link to Create the AFD Endpoint" translate="no">​</a></h3>
<p>In &#x27;Front Door manager&#x27; select &#x27;Add an endpoint&#x27; and give the endpoint a name. Make note of the FQDN is provides. This will be used in our DNS for the CNAME.</p>
<p><img decoding="async" loading="lazy" alt="add an endpoint 1" src="/assets/images/addendpoint1-8a7657fa4dee42db284d4b38c7003bfd.jpg" width="1094" height="554" class="img_ev3q"></p>
<p>Now we&#x27;ll add a route by clicking &#x27;Add a route&#x27;.</p>
<p><img decoding="async" loading="lazy" alt="add an endpoint 2" src="/assets/images/addendpoint2-99a313ff2cd2b776d3c1dc23157ee62f.jpg" width="1472" height="571" class="img_ev3q"></p>
<p>In the &#x27;add route&#x27; screen, we&#x27;ll select our origin and the associated domain, and set any additional options. At this point, you should also make note of the endpoint FQDN, which we&#x27;ll need to use as our CNAME in our DNS for our host name.</p>
<p><img decoding="async" loading="lazy" alt="add an endpoint 3" src="/assets/images/addendpoint3-c06fd89920842350cdc44dc39ab7ebaf.jpg" width="929" height="1157" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="add an endpoint 4" src="/assets/images/addendpoint4-f8ddd53f17f80fc96dea5563f8a8022c.jpg" width="862" height="270" class="img_ev3q"></p>
<p>When finished, your endpoint should look as follows.</p>
<p><img decoding="async" loading="lazy" alt="add an endpoint 5" src="/assets/images/addendpoint5-89e54f6811a19af215df9063f4d68702.jpg" width="1142" height="429" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="update-your-dns">Update your DNS<a href="#update-your-dns" class="hash-link" aria-label="Direct link to Update your DNS" title="Direct link to Update your DNS" translate="no">​</a></h3>
<p>We need our DNS name to point to the Azure Front Door endpoint, so we&#x27;ll take that Front Door provided FQDN and create a CNAME record.</p>
<p><img decoding="async" loading="lazy" alt="dns cname entry" src="/assets/images/dnscname-8fbedb12cb53f94762424bf996a3d132.jpg" width="1156" height="108" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="approve-the-private-link-request">Approve the Private Link request<a href="#approve-the-private-link-request" class="hash-link" aria-label="Direct link to Approve the Private Link request" title="Direct link to Approve the Private Link request" translate="no">​</a></h3>
<p>Ok, so we associated the Azure Front Door origin with our private link, but we never approved the private link association request. To do that, we&#x27;ll need to go to the AKS managed cluster (MC_) resource group. Lets get that resource group name and then go approve the request.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get the managed cluster resource group name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AKS_CLUSTER_MC_RG</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $CLUSTER_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> nodeResourceGroup</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><br></span></code></pre></div></div>
<p>Back in the Azure Portal, navigate to the Managed Cluster Resource Group and find the private link.</p>
<p><img decoding="async" loading="lazy" alt="approve private link 1" src="/assets/images/approvepl1-87e675028c6844a6ca14ba78885ab29e.jpg" width="1597" height="783" class="img_ev3q"></p>
<p>Click on the &#x27;Private endpoint connections&#x27; where you should see a pending request.</p>
<p><img decoding="async" loading="lazy" alt="approve private link 2" src="/assets/images/approvepl2-c958b49e159cb530586c4ae8847aaaf7.jpg" width="1500" height="445" class="img_ev3q"></p>
<p>Select the private link and click &#x27;Approve&#x27;.</p>
<p><img decoding="async" loading="lazy" alt="approve private link 3" src="/assets/images/approvepl3-70628f6d17487ce753fcacaade5dd549.jpg" width="663" height="201" class="img_ev3q"></p>
<p>You&#x27;ll see a dialog box with the message you sent when creating the origin connection.</p>
<p><img decoding="async" loading="lazy" alt="approve private link 4" src="/assets/images/approvepl4-61865f245d88072ea396e0da64fc1d21.jpg" width="773" height="224" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="test">Test<a href="#test" class="hash-link" aria-label="Direct link to Test" title="Direct link to Test" translate="no">​</a></h2>
<p>You should now be able to open a browser and navigate to your URL. You can also test with curl.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> https://e2elab.crashoverride.nyc/hello-world</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">##########################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Sample Output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">##########################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Hostname: aks-helloworld-fbdf59bf-qtdks</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Pod Information:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-no</span><span class="token plain"> pod information available-</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Server values:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">server_version</span><span class="token operator">=</span><span class="token plain">nginx: </span><span class="token number">1.13</span><span class="token plain">.3 - lua: </span><span class="token number">10008</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Request Information:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">client_address</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">method</span><span class="token operator">=</span><span class="token plain">GET</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	real </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">path</span><span class="token operator">=</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">query</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">request_version</span><span class="token operator">=</span><span class="token number">1.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">request_scheme</span><span class="token operator">=</span><span class="token plain">http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">request_uri</span><span class="token operator">=</span><span class="token plain">http://e2elab.crashoverride.nyc:8080/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Request Headers:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">accept</span><span class="token operator">=</span><span class="token plain">*/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">host</span><span class="token operator">=</span><span class="token plain">e2elab.crashoverride.nyc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	user-agent</span><span class="token operator">=</span><span class="token plain">curl/8.7.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">via</span><span class="token operator">=</span><span class="token plain">HTTP/2.0 Azure</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-azure-clientip</span><span class="token operator">=</span><span class="token number">70.18</span><span class="token plain">.42.220</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-azure-fdid</span><span class="token operator">=</span><span class="token plain">c7e0d3e0-830a-4770-acae-14d27c7726f8</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-azure-ref</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-azure-requestchainv2</span><span class="token operator">=</span><span class="token plain">hops</span><span class="token operator">=</span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-azure-socketip</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-forwarded-for</span><span class="token operator">=</span><span class="token number">10.140</span><span class="token plain">.0.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-forwarded-host</span><span class="token operator">=</span><span class="token plain">e2elab.crashoverride.nyc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-forwarded-port</span><span class="token operator">=</span><span class="token number">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-forwarded-proto</span><span class="token operator">=</span><span class="token plain">https</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-forwarded-scheme</span><span class="token operator">=</span><span class="token plain">https</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-original-forwarded-for</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-real-ip</span><span class="token operator">=</span><span class="token number">10.140</span><span class="token plain">.0.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-request-id</span><span class="token operator">=</span><span class="token plain">8f41e792d8f0f74e90ddca9d14ba896b</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	x-scheme</span><span class="token operator">=</span><span class="token plain">https</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Request Body:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-no</span><span class="token plain"> body </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> request-</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Congrats! You should now have a working Azure Front Door directing TLS secured traffic to an in cluster ingress controller!</p>
<blockquote>
<p><em>Note:</em> In this walk through we did not add encryption between the ingress controller and the backend deployment. This can be done by sharing the same, or different, certificate to the deployment pods. You then enable backend encryption on the ingress controller. Alternatively, you could use a service mesh between the ingress and the backend deployment.</p>
</blockquote></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/appdevgbb/gbb-blog/tree/main/docusaurus/blog/2024-11-05/afd-aks-ingress-tls/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2025/01/31/updating-aks-network-plugin-from-kubenet-to-azure-cni"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Updating AKS Network Plugin from Kubenet to Azure CNI</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2024/09/06/multi-cluster-layer-4-load-balancing-with-fleet-manager"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Multi-Cluster Layer 4 Load Balancing with Fleet Manager</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#network-setup" class="table-of-contents__link toc-highlight">Network Setup</a></li><li><a href="#cluster-creation" class="table-of-contents__link toc-highlight">Cluster Creation</a></li><li><a href="#setup-workload-identity" class="table-of-contents__link toc-highlight">Setup Workload Identity</a></li><li><a href="#create-the-azure-key-vault-and-upload-certificate" class="table-of-contents__link toc-highlight">Create the Azure Key Vault and Upload Certificate</a><ul><li><a href="#option-1-app-service-certificates" class="table-of-contents__link toc-highlight">Option 1: App Service Certificates</a></li><li><a href="#option-2-letsencryptcertbot" class="table-of-contents__link toc-highlight">Option 2: LetsEncrypt/CertBot</a></li></ul></li><li><a href="#set-up-the-key-vault-csi-secret-provider-class" class="table-of-contents__link toc-highlight">Set up the Key Vault CSI Secret Provider Class</a></li><li><a href="#deploy-the-ingress-controller" class="table-of-contents__link toc-highlight">Deploy the Ingress Controller</a></li><li><a href="#deploy-a-sample-app" class="table-of-contents__link toc-highlight">Deploy a Sample App</a></li><li><a href="#create-the-azure-front-door" class="table-of-contents__link toc-highlight">Create the Azure Front Door</a><ul><li><a href="#link-the-certificate-to-the-afd" class="table-of-contents__link toc-highlight">Link the certificate to the AFD.</a></li><li><a href="#create-the-custom-domain-configuration" class="table-of-contents__link toc-highlight">Create the Custom Domain Configuration</a></li><li><a href="#create-the-origin-group" class="table-of-contents__link toc-highlight">Create the Origin Group</a></li><li><a href="#create-the-afd-endpoint" class="table-of-contents__link toc-highlight">Create the AFD Endpoint</a></li><li><a href="#update-your-dns" class="table-of-contents__link toc-highlight">Update your DNS</a></li><li><a href="#approve-the-private-link-request" class="table-of-contents__link toc-highlight">Approve the Private Link request</a></li></ul></li><li><a href="#test" class="table-of-contents__link toc-highlight">Test</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Posts</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/gbb-blog">Posts</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/appdevgbb" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://learn.microsoft.com/azure/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Microsoft Learn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://azure.microsoft.com/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Azure Blog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/stevegriffith" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 App Innovation Global Blackbelt. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>