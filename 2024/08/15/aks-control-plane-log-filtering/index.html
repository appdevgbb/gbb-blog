<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Using Stream Analytics to Filter AKS Control Plane Logs | Azure Global Blackbelt</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://azureglobalblackbelts.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://azureglobalblackbelts.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://azureglobalblackbelts.com/2024/08/15/aks-control-plane-log-filtering"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Using Stream Analytics to Filter AKS Control Plane Logs | Azure Global Blackbelt"><meta data-rh="true" name="description" content="Using Azure Stream Analytics to filter Kubernetes control plane log data from AKS diagnostics in order to isolate critical data and reduce log retention cost."><meta data-rh="true" property="og:description" content="Using Azure Stream Analytics to filter Kubernetes control plane log data from AKS diagnostics in order to isolate critical data and reduce log retention cost."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-08-15T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/swgriffith"><link data-rh="true" rel="icon" href="/img/gbb.png"><link data-rh="true" rel="canonical" href="https://azureglobalblackbelts.com/2024/08/15/aks-control-plane-log-filtering"><link data-rh="true" rel="alternate" href="https://azureglobalblackbelts.com/2024/08/15/aks-control-plane-log-filtering" hreflang="en"><link data-rh="true" rel="alternate" href="https://azureglobalblackbelts.com/2024/08/15/aks-control-plane-log-filtering" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://azureglobalblackbelts.com/2024/08/15/aks-control-plane-log-filtering","mainEntityOfPage":"https://azureglobalblackbelts.com/2024/08/15/aks-control-plane-log-filtering","url":"https://azureglobalblackbelts.com/2024/08/15/aks-control-plane-log-filtering","headline":"Using Stream Analytics to Filter AKS Control Plane Logs","name":"Using Stream Analytics to Filter AKS Control Plane Logs","description":"Using Azure Stream Analytics to filter Kubernetes control plane log data from AKS diagnostics in order to isolate critical data and reduce log retention cost.","datePublished":"2024-08-15T00:00:00.000Z","author":{"@type":"Person","name":"Steve Griffith","description":"Principal Cloud Architect, Azure Global Black Belt","url":"https://github.com/swgriffith","image":"https://github.com/swgriffith.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://azureglobalblackbelts.com/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Azure Global Blackbelt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Azure Global Blackbelt Atom Feed"><link rel="stylesheet" href="/assets/css/styles.5718cfe7.css">
<script src="/assets/js/runtime~main.b4103c26.js" defer="defer"></script>
<script src="/assets/js/main.67e1397c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/gbb.png"><link rel="preload" as="image" href="https://github.com/swgriffith.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/gbb.png" alt="Azure Global Blackbelt Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/gbb.png" alt="Azure Global Blackbelt Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Azure Global Blackbelt</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/appdevgbb" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/07/02/when-infrastructure-scales-but-understanding-doesnt">When Infrastructure Scales But Understanding Doesn&#x27;t</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/06/24/human-scale-problem-in-platform-engineering">The Human Scale Problem in Platform Engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/01/31/updating-aks-network-plugin-from-kubenet-to-azure-cni">Updating AKS Network Plugin from Kubenet to Azure CNI</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/11/05/afd-aks-ingress-tls">End to End TLS Encryption with AKS and AFD</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/09/06/multi-cluster-layer-4-load-balancing-with-fleet-manager">Multi-Cluster Layer 4 Load Balancing with Fleet Manager</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/2024/08/15/aks-control-plane-log-filtering">Using Stream Analytics to Filter AKS Control Plane Logs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/04/16/aks-kaito">Using Project KAITO in AKS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/03/05/workload-identity-kv-csi">Using the Azure Key Vault CSI Driver with Workload Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024/02/02/securing-your-aks-cluster-with-a-linux-firewall-vm">Securing your AKS cluster with a Linux Firewall VM</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/12/19/workload-identity-blob-example">Using Workload Idenity to Access Azure Blob Storage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/12/18/external-dns-workload-identity">Using External DNS in AKS with Azure Workload Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/27/capabilities-in-aks">Using Linux Capabilities in AKS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/09/part1-notation-usage">Image Verification Part 1 - Notation CLI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/11/09/part2-aks-image-verification">Image Verification Part 2 - Image Verification with Gatekeeper and Ratify</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/10/26/aks-custom-policy">AKS Custom Policy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/10/12/aks-user-min-roles">AKS User Minimum Roles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/agc-egress-lockdown">Using App Gateway for Containers with Egress Lockdown</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/kubelogin-terraform">Using Kubelogin with AKS via Terraform</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/09/21/workload-identity-example">Workload Identity</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-azuresql-example">Accessing Azure SQL DB via Workload Identity and Managed Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-self-managed-setup">Using Workload Identity with Self Managed Clusters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021/09/21/workload-identity-windows-example">Workload Identity - Windows Nodepool Walkthrough</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Using Stream Analytics to Filter AKS Control Plane Logs</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-08-15T00:00:00.000Z">August 15, 2024</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/swgriffith" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/swgriffith.png" alt="Steve Griffith"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/swgriffith" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp" translate="no">Steve Griffith</span></a></div><small class="authorTitle_nd0D" title="Principal Cloud Architect, Azure Global Black Belt">Principal Cloud Architect, Azure Global Black Belt</small><div class="authorSocials_rSDt"><a href="https://x.com/SteveGriffith" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="X"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 1200 1227" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 xSvg_y3PF"><path d="M714.163 519.284 1160.89 0h-105.86L667.137 450.887 357.328 0H0l468.492 681.821L0 1226.37h105.866l409.625-476.152 327.181 476.152H1200L714.137 519.284h.026ZM569.165 687.828l-47.468-67.894-377.686-540.24h162.604l304.797 435.991 47.468 67.894 396.2 566.721H892.476L569.165 687.854v-.026Z"></path></svg></a><a href="https://github.com/swgriffith" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction" translate="no">​</a></h2>
<p>While AKS does NOT provide access to the cluster&#x27;s managed control plane, it does provide access to the control plane component logs via <a href="https://learn.microsoft.com/en-us/azure/aks/monitor-aks#aks-control-planeresource-logs" target="_blank" rel="noopener noreferrer" class="">diagnostic settings</a>. The easiest option to persist and search this data is to send it directly to Azure Log Analytics, however there is a LOT of data in those logs, which makes it cost prohibitive in Log Analytics. Alternatively, you can send all the data to an Azure Storage Account, but then searching and alerting can be challenging.</p>
<p>To address the above challenge, one option is to stream the data to Azure Event Hub, which then gives you the option to use Azure Stream Analytics to filter out events that you deem important and then just store the rest in cheaper storage (ex. Azure Storage) for potential future diagnostic needs.</p>
<p>In this walkthrough we&#x27;ll create an AKS cluster, enable diagnostic logging to Azure Stream Analytics and then demonstrate how to filter out some key records.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="cluster--stream-analytics-setup">Cluster &amp; Stream Analytics Setup<a href="#cluster--stream-analytics-setup" class="hash-link" aria-label="Direct link to Cluster &amp; Stream Analytics Setup" title="Direct link to Cluster &amp; Stream Analytics Setup" translate="no">​</a></h2>
<p>In this setup, the cluster will be a very basic single node AKS cluster that will simply have diagnostic settings enabled. We&#x27;ll also create the Event Hub instance that will be used in the diagnostic settings.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Set some environment variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">RG</span><span class="token operator">=</span><span class="token plain">LogFilteringLab</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">LOC</span><span class="token operator">=</span><span class="token plain">eastus2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CLUSTER_NAME</span><span class="token operator">=</span><span class="token plain">logfilterlab</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">NAMESPACE_NAME</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;akscontrolplane</span><span class="token string environment constant" style="color:rgb(189, 147, 249)">$RANDOM</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">EVENT_HUB_NAME</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;logfilterhub</span><span class="token string environment constant" style="color:rgb(189, 147, 249)">$RANDOM</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">DIAGNOSTIC_SETTINGS_NAME</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;demologfilter&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a resource group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az group create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-l</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$LOC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the AKS Cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CLUSTER_NAME</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-c</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Get the cluster credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az aks get-credentials </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CLUSTER_NAME</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create an Event Hub Namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az eventhubs namespace create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$NAMESPACE_NAME</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-l</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$LOC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create an event hub</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az eventhubs eventhub create </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EVENT_HUB_NAME</span><span class="token plain"> --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> --namespace-name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$NAMESPACE_NAME</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AKS_CLUSTER_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az aks show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $CLUSTER_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">EVENT_HUB_NAMESPACE_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">az eventhubs namespace show </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-g</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $RG </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $NAMESPACE_NAME </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> tsv </span><span class="token variable parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--query</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Apply the diagnostic settings to the AKS cluster to enable Kubernetes audit log shipping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># to our Event Hub</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az monitor diagnostic-settings create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--resource</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AKS_CLUSTER_ID</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$DIAGNOSTIC_SETTINGS_NAME</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--event-hub </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$EVENT_HUB_NAME</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--event-hub-rule </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${EVENT_HUB_NAMESPACE_ID}</span><span class="token string" style="color:rgb(255, 121, 198)">/authorizationrules/RootManageSharedAccessKey&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--logs</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;[ { &quot;category&quot;: &quot;kube-audit&quot;, &quot;enabled&quot;: true, &quot;retentionPolicy&quot;: { &quot;enabled&quot;: false, &quot;days&quot;: 0 } } ]&#x27;</span><span class="token plain"> </span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="stream-analytics">Stream Analytics<a href="#stream-analytics" class="hash-link" aria-label="Direct link to Stream Analytics" title="Direct link to Stream Analytics" translate="no">​</a></h2>
<p>As we&#x27;ll use Stream Analytics to filter through the log messages for what we want to capture, we&#x27;ll need to create a Stream Analytics Job. This job will take the Event Hub as it&#x27;s input source, will run a query and will send the query results to an output target. This output target can be a number of options, but for the purposes of our test we&#x27;ll write the filtered records out to a Service Bus Queue, which we can watch in real time.</p>
<p>We have the Event Hub already, now lets create the Azure Service Bus Queue and then the Stream Analytics Job to tie it all together.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-the-service-bus-queue">Create the Service Bus Queue<a href="#create-the-service-bus-queue" class="hash-link" aria-label="Direct link to Create the Service Bus Queue" title="Direct link to Create the Service Bus Queue" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICE_BUS_NAMESPACE_NAME</span><span class="token operator">=</span><span class="token plain">kubecontrolplanelogs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICE_BUS_QUEUE_NAME</span><span class="token operator">=</span><span class="token plain">kubeaudit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the service bus namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az servicebus namespace create --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SERVICE_BUS_NAMESPACE_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--location</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$LOC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create the service bus queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">az servicebus queue create --resource-group </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$RG</span><span class="token plain"> --namespace-name </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SERVICE_BUS_NAMESPACE_NAME</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--name</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SERVICE_BUS_QUEUE_NAME</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="stream-analytics-job">Stream Analytics Job<a href="#stream-analytics-job" class="hash-link" aria-label="Direct link to Stream Analytics Job" title="Direct link to Stream Analytics Job" translate="no">​</a></h3>
<p>For the Stream Analytics Job we&#x27;ll switch over to the portal, so go ahead and open <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer" class="">https://portal.azure.com</a> and navigate to your resource group.</p>
<ol>
<li class="">
<p>Click on the &#x27;Create&#x27; button at the top of your resource group:</p>
<p><img decoding="async" loading="lazy" alt="Create" src="/assets/images/rg-create-99803d7b32b0e097c0deb252707b0205.jpg" width="782" height="336" class="img_ev3q"></p>
</li>
<li class="">
<p>Search for &#x27;Stream Analytics Job&#x27;</p>
<p><img decoding="async" loading="lazy" alt="Search" src="/assets/images/sa-job-search-0e9811af2fb29f0c191495a426ca018c.jpg" width="815" height="287" class="img_ev3q"></p>
</li>
<li class="">
<p>Click &#x27;Create&#x27; on the Stream Analytics Job search result</p>
<p><img decoding="async" loading="lazy" alt="Search Result" src="/assets/images/sa-job-search-result-ae62aa50a6a18c5e7884f32d560498c2.jpg" width="556" height="732" class="img_ev3q"></p>
</li>
<li class="">
<p>Leave all defaults, but provide a name under the &#x27;Instance Details&#x27; section and then click &#x27;Review + Create&#x27;</p>
<p><img decoding="async" loading="lazy" alt="Create Instance" src="/assets/images/sa-job-create-instance-63f770088d59ec19c065713eb792dc7a.jpg" width="769" height="968" class="img_ev3q"></p>
</li>
<li class="">
<p>After the validation is complete, just click &#x27;Create&#x27;. This typically completes very quickly.</p>
</li>
<li class="">
<p>Click on &#x27;Go to Resource&#x27; or navigate back to your resource group and click on the Stream Analytics Job you just created.</p>
</li>
<li class="">
<p>In the stream analytics job, expand &#x27;Job topology&#x27; and then click on &#x27;Inputs&#x27; so we can add our Event Hub input</p>
<p><img decoding="async" loading="lazy" alt="Stream Analytics Job - Add Input" src="/assets/images/sa-job-inputs-8cde4e621406ae680a459f2a8831687a.jpg" width="733" height="494" class="img_ev3q"></p>
</li>
<li class="">
<p>Click on &#x27;Add Input&#x27; and select &#x27;Event Hub&#x27;</p>
<p><img decoding="async" loading="lazy" alt="Create Input" src="/assets/images/sa-job-create-input-f54413dfdecd3bf2e930bd55e5e521ad.jpg" width="614" height="315" class="img_ev3q"></p>
</li>
<li class="">
<p>The Event Hub&#x27;s new input creation pane should auto-populate with your Event Hub details as well as default to creation of a new access policy, but verify that all of the details are correct and then click &#x27;Save&#x27;.</p>
<p><img decoding="async" loading="lazy" alt="Event Hub Config Details" src="/assets/images/sa-event-hub-config-ebc016ee9a33439bfa889b1c55b13b51.jpg" width="303" height="980" class="img_ev3q"></p>
</li>
<li class="">
<p>Now we need to attach the Service Bus we created as the output target, so under &#x27;Job topology&#x27; click on &#x27;Outputs&#x27;.</p>
</li>
<li class="">
<p>In the &#x27;Outputs&#x27; window, click on &#x27;Add output&#x27; and select &#x27;Service Bus queue&#x27;</p>
<p><img decoding="async" loading="lazy" alt="Add Output" src="/assets/images/sa-add-output-2a60e9127196c7669392867820b9d34d.jpg" width="597" height="539" class="img_ev3q"></p>
</li>
<li class="">
<p>Again, it should bring up a window with the queue configuration details already pre-populated, but verify all the details and update as needed and then click &#x27;Save&#x27;.</p>
<p><img decoding="async" loading="lazy" alt="Service Bus Config" src="/assets/images/sa-servicebus-config-9182e36515ff344d683c7fc34846dcd1.jpg" width="351" height="1006" class="img_ev3q"></p>
</li>
<li class="">
<p>To process the records from AKS we&#x27;ll need to parse some JSON, so we need to add a function to the Stream Analytics Job to parse JSON. Under &#x27;Job topology&#x27; click on &#x27;Functions&#x27;.</p>
</li>
<li class="">
<p>In the functions window, click on &#x27;Add Function&#x27; and then select &#x27;Javascript UDF&#x27; for Javascript User Defined Function</p>
<p><img decoding="async" loading="lazy" alt="Create Function" src="/assets/images/sa-create-function-c327143655504ecfeb0cbf5fbf19be87.jpg" width="616" height="540" class="img_ev3q"></p>
</li>
<li class="">
<p>In the &#x27;Function alias&#x27; name the function &#x27;jsonparse&#x27; and in the editor window add the following:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> json </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">parse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Function" src="/assets/images/sa-javascript-udf-928667029ff39c9443d25a1fea93076f.jpg" width="832" height="298" class="img_ev3q"></p>
</li>
<li class="">
<p>Click on &#x27;Save&#x27; to save the function</p>
</li>
<li class="">
<p>Now, under &#x27;Job topology&#x27; in the stream analytics job, click on &#x27;Query&#x27; to start adding a query. When loaded, the inputs, outputs and functions should pre-populate for you.</p>
</li>
<li class="">
<p>We&#x27;ll first create a basic query to select all records and ship them to the output target. In the query window paste the following, updating the input and output values to match the names of your input and output. The function name should be the same unless you changed it.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WITH</span><span class="token plain"> DynamicCTE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> UDF</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">jsonparse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">individualRecords</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ArrayValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">logfilterhub28026</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CROSS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">APPLY</span><span class="token plain"> GetArrayElements</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">records</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> individualRecords</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">kubeauditlogs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> DynamicCTE</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Click &#x27;Save Query&#x27; at the top of the query window</p>
<p><img decoding="async" loading="lazy" alt="Save Query" src="/assets/images/sa-save-query-720e75066a0399cde63b0d3154192468.jpg" width="1249" height="427" class="img_ev3q"></p>
</li>
<li class="">
<p>In the top left of the query window, click on &#x27;Start Job&#x27; to kick off the stream analytics job.</p>
</li>
<li class="">
<p>In the &#x27;Start job&#x27; window, leave the start time set to &#x27;Now&#x27; and click &#x27;Start&#x27;</p>
<p><img decoding="async" loading="lazy" alt="Start Job" src="/assets/images/sa-start-job-f60feaff9f6ddb6263722ddaf7f2b97c.jpg" width="1752" height="485" class="img_ev3q"></p>
</li>
<li class="">
<p>Click on the &#x27;Overview&#x27; tab in the stream analytics job, and refresh every once in a while until the job &#x27;Status&#x27; says &#x27;Running&#x27;</p>
<p><img decoding="async" loading="lazy" alt="Job Running" src="/assets/images/sa-job-status-running-0b03c0ac435fed6ab0a0d05f1a1546a9.jpg" width="972" height="320" class="img_ev3q"></p>
</li>
<li class="">
<p>Navigate back to your Resource Group and then click on your service bus namespace.</p>
</li>
<li class="">
<p>Assuming everything worked as expected you should now be seeing a lot of messages coming through the Service Bus Queue</p>
<p><img decoding="async" loading="lazy" alt="Service Bus Namespace with Data" src="/assets/images/sb-namespace-live-19fd1b1681abc1e02cbbb1543e021929.jpg" width="1580" height="919" class="img_ev3q"></p>
</li>
<li class="">
<p>Click on the queue at the bottom of the screen to open the Queue level view</p>
</li>
<li class="">
<p>At the queue level, click on &#x27;Service Bus Explorer&#x27; to view the live records</p>
</li>
<li class="">
<p>To view the records already created&#x27; click on &#x27;Peek from start&#x27; and then choose a record to view</p>
<p><img decoding="async" loading="lazy" alt="Live Audit Record" src="/assets/images/sb-audit-record-d16aab23dd67edf6db6222284941d72d.jpg" width="1569" height="766" class="img_ev3q"></p>
</li>
<li class="">
<p>Navigate back to the stream analytics job and click on &#x27;Stop job&#x27; to stop sending records through to the service bus.</p>
</li>
</ol>
<p>Great! You should now have a very basic stream analytics job that takes the control plane &#x27;kube-audit&#x27; log from an AKS cluster through Event Hub, queries that data and then pushes it to a Service Bus Queue. While this is great, the goal is to filter out some records, so lets move on to that!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-a-test-workload-to-trigger-audit-log-entries">Setup a test workload to trigger audit log entries<a href="#setup-a-test-workload-to-trigger-audit-log-entries" class="hash-link" aria-label="Direct link to Setup a test workload to trigger audit log entries" title="Direct link to Setup a test workload to trigger audit log entries" translate="no">​</a></h2>
<p>To test out our stream analytics query, we need some test data we can filter on. Let&#x27;s create some requests to the API server that will be denied. To do that we&#x27;ll create a service account with no rights and then create a test pod using that service account. We&#x27;ll then use the service account token to try to reach the Kubernetes API server.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Create a new namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl create ns demo-ns</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a service account in the namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl create sa demo-user </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> demo-ns</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a test secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl create secret generic demo-secret </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> demo-ns --from-literal </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;message=hey-there&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check that you can read the secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl get secret demo-secret </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> demo-ns </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-o</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">jsonpath</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;{.data.message}&#x27;</span><span class="token operator">|</span><span class="token plain">base64 </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--decode</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Create a test pod to try to query the API server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl run curlpod </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--rm</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-it</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--image</span><span class="token operator">=</span><span class="token plain">curlimages/curl </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-n</span><span class="token plain"> demo-ns </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--overrides</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;{ &quot;spec&quot;: { &quot;serviceAccount&quot;: &quot;demo-user&quot; }  }&#x27;</span><span class="token plain"> -- </span><span class="token function" style="color:rgb(80, 250, 123)">sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#############################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># From within the pod run the following</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">#############################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Point to the internal API server hostname</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">APISERVER</span><span class="token operator">=</span><span class="token plain">https://kubernetes.default.svc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Path to ServiceAccount token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICEACCOUNT</span><span class="token operator">=</span><span class="token plain">/var/run/secrets/kubernetes.io/serviceaccount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Read this Pod&#x27;s namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">NAMESPACE</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">cat</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICEACCOUNT</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">/namespace</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Read the ServiceAccount bearer token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">TOKEN</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">cat</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> $</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">{</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">SERVICEACCOUNT</span><span class="token variable punctuation" style="color:rgb(248, 248, 242);font-style:italic">}</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">/token</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Reference the internal certificate authority (CA)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">CACERT</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${SERVICEACCOUNT}</span><span class="token plain">/ca.crt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Explore the API with TOKEN </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This call will pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--cacert</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CACERT}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--header</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Authorization: Bearer </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${TOKEN}</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token plain"> GET </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${APISERVER}</span><span class="token plain">/api</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># This call to get secrets will fail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--cacert</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${CACERT}</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">--header</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Authorization: Bearer </span><span class="token string variable" style="color:rgb(189, 147, 249);font-style:italic">${TOKEN}</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(189, 147, 249);font-style:italic">-X</span><span class="token plain"> GET </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${APISERVER}</span><span class="token plain">/api/v1/namespaces/</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$NAMESPACE</span><span class="token plain">/secrets/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Now run it under a watch to trigger continuous deny errors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">watch</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;curl --cacert ${CACERT} --header &quot;Authorization: Bearer ${TOKEN}&quot; -X GET ${APISERVER}/api/v1/namespaces/$NAMESPACE/secrets/&#x27;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="update-stream-analytics-to-look-for-forbidden-requests">Update Stream Analytics to Look for Forbidden Requests<a href="#update-stream-analytics-to-look-for-forbidden-requests" class="hash-link" aria-label="Direct link to Update Stream Analytics to Look for Forbidden Requests" title="Direct link to Update Stream Analytics to Look for Forbidden Requests" translate="no">​</a></h2>
<p>So, we have a user trying to execute requests against our cluster for which they are not authorized. We can easily update our stream analytics query to filter out forbidden requests against our namespace.</p>
<ol>
<li class="">
<p>Navigate back to your &#x27;Stream Analytics&#x27; instances in the Azure Portal</p>
</li>
<li class="">
<p>If the job is still running, make sure you click &#x27;Stop job&#x27; as you cannot edit queries while the job is running</p>
</li>
<li class="">
<p>Click on the &#x27;Query&#x27; tab</p>
</li>
<li class="">
<p>Update the query as follows, to filter out audit messages about our &#x27;demo-ns&#x27; namespace that also have a status code of 403 (Forbidden)</p>
<blockquote>
<p><strong>Note:</strong> Be sure that your &#x27;FROM&#x27; still points to your Event Hub input target and that your &#x27;INTO&#x27; still points to your Service Bus output target.</p>
</blockquote>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WITH</span><span class="token plain"> DynamicCTE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> UDF</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">jsonparse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">individualRecords</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ArrayValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">logfilterhub28026</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CROSS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">APPLY</span><span class="token plain"> GetArrayElements</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">records</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> individualRecords</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTO</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">kubeaudit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> DynamicCTE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">objectRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">namespace </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;demo-ns&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">AND</span><span class="token plain"> log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">responseStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">code </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">403</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="Updated Query Window" src="/assets/images/sa-403-query-7b6159d3e86712bd830c5eaa1fbbe6f4.jpg" width="1298" height="513" class="img_ev3q"></p>
</li>
<li class="">
<p>Click &#x27;Save query&#x27;</p>
</li>
<li class="">
<p>Once the save completes click &#x27;Start Job&#x27;</p>
</li>
</ol>
<p>Once your job is started, you should be able to navigate back to your Service Bus Queue and watch the messages flowing through.</p>
<p><img decoding="async" loading="lazy" alt="Filtered Messages" src="/assets/images/sb-filtered-messages-c6013da3b7b2ffb21ae0905c19b494df.jpg" width="1773" height="708" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Congratulations! You now have an end-to-end fully working Stream Analytics instance that can filter AKS control plane logs to extract specific messages. You can manipulate the diagnostic settings to add additional logs to the input and modify the query to extract the exact messages critical to your cluster&#x27;s health and security. This is an extremely versatile solution that is also capable of handling log records of multiple clusters across your enterprise.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/appdevgbb/gbb-blog/tree/main/docusaurus/blog/2024-08-15/aks-control-plane-log-filtering/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2024/09/06/multi-cluster-layer-4-load-balancing-with-fleet-manager"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Multi-Cluster Layer 4 Load Balancing with Fleet Manager</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2024/04/16/aks-kaito"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Using Project KAITO in AKS</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#cluster--stream-analytics-setup" class="table-of-contents__link toc-highlight">Cluster &amp; Stream Analytics Setup</a></li><li><a href="#stream-analytics" class="table-of-contents__link toc-highlight">Stream Analytics</a><ul><li><a href="#create-the-service-bus-queue" class="table-of-contents__link toc-highlight">Create the Service Bus Queue</a></li><li><a href="#stream-analytics-job" class="table-of-contents__link toc-highlight">Stream Analytics Job</a></li></ul></li><li><a href="#setup-a-test-workload-to-trigger-audit-log-entries" class="table-of-contents__link toc-highlight">Setup a test workload to trigger audit log entries</a></li><li><a href="#update-stream-analytics-to-look-for-forbidden-requests" class="table-of-contents__link toc-highlight">Update Stream Analytics to Look for Forbidden Requests</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Posts</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/gbb-blog">Posts</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/appdevgbb" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://learn.microsoft.com/azure/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Microsoft Learn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://azure.microsoft.com/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Azure Blog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/stevegriffith" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 App Innovation Global Blackbelt. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>